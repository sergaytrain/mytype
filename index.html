<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mytype.pro – Тренажер Печати (Dark/Light)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Динамическая иконка сайта -->
    <link id="favicon" rel="icon" type="image/x-icon">
    
    <style>
        /* ==================================================================== */
        /* --- CSS Переменные для ТЕМ --- */
        /* ==================================================================== */
        :root { 
            /* Light Theme (Базовые переменные) */
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333333;
            --label-color: #6c757d;
            --placeholder-color: #aaaaaa;
            --input-bg: #e9ecef;
            --border-color: #ced4da;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            
            /* Общие */
            --font-family: 'Roboto Mono', monospace; 
            --accent-color: #007bff; 
            --success-color: #28a745; 
            --error-color: #dc3545; 
            --cursor-color: #ffc107; 
        }

        /* Dark Theme (Переопределение) */
        [data-theme="dark"] {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --label-color: #bdc3c7;
            --placeholder-color: #7f8c8d;
            --input-bg: #22303f;
            --border-color: #405973;
            --shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        /* ==================================================================== */
        /* --- Общие стили и СБРОС --- */
        /* ==================================================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        /* Шапка и Логотип */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            position: relative;
            width: 100%;
            max-width: 900px;
        }

        .logo {
            font-size: 3em;
            font-weight: 700;
            color: var(--text-color);
            transition: color 0.3s;
        }

        .logo .pro {
            color: var(--accent-color);
        }

        .slogan {
            font-size: 1.1em;
            color: var(--label-color);
            margin-top: 5px;
            transition: color 0.3s;
        }

        /* Кнопка смены темы */
        .theme-toggle-btn {
            position: absolute;
            top: 35px;
            right: 0;
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-toggle-btn:hover {
            opacity: 0.8;
        }
        
        /* --- Контейнеры --- */
        .test-container {
            width: 100%;
            max-width: 900px; 
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            position: relative;
            box-shadow: var(--shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        /* --- Инфо-Панель и Кнопки --- */
        .time-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .time-btn {
            padding: 10px 20px;
            font-size: 1em;
            font-weight: 700;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-btn:hover {
            border-color: var(--accent-color);
        }

        .time-btn.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .info-panel {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid var(--accent-color);
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .info-item .label {
            display: block;
            font-size: 0.9em;
            color: var(--label-color);
        }

        .info-item .value {
            font-size: 1.8em;
            font-weight: 700;
        }

        .error-value {
            color: var(--error-color);
        }

        /* --- Текстовая область с прокруткой --- */
        .typing-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Окно, ограничивающее видимость текста */
        .text-window {
            height: 60px; 
            overflow: hidden; 
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center; 
            width: 570px; 
            margin: 0 auto; 
            padding: 0 100px;
            font-size: 2.2em;
            border-radius: 8px;
            background-color: var(--input-bg);
            transition: background-color 0.3s;
        }

        /* Контейнер для всего текста */
        #text-to-type {
            white-space: nowrap; 
            position: absolute;
            left: 0; 
            transform: translateX(0);
            transition: transform 0.1s ease-out; 
            user-select: none;
            line-height: 1;
        }

        /* Стиль для правильных символов */
        #text-to-type span.correct {
            color: var(--success-color);
        }

        /* Стиль для неправильных символов */
        #text-to-type span.incorrect {
            color: var(--error-color);
            text-decoration: underline 2px solid var(--error-color);
        }

        /* Стиль для ТЕКУЩЕГО символа (эффект курсора) */
        #text-to-type span.current {
            border-right: 2px solid var(--cursor-color); 
            animation: blink-current 1s step-end infinite;
        }

        /* Анимация мигания курсора */
        @keyframes blink-current {
            from, to { border-right-color: var(--cursor-color); }
            50% { border-right-color: transparent; }
        }

        .placeholder-text {
            font-size: 0.7em;
            color: var(--placeholder-color);
            display: block;
            padding: 10px 0;
            transition: color 0.3s;
        }

        /* --- Кнопка Старта и Модальное Окно --- */
        .start-button {
            padding: 15px 30px;
            font-size: 1.5em;
            font-weight: 700;
            color: #ffffff;
            background-color: var(--accent-color);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
        }
        .start-button:hover {
            background-color: #0056b3;
        }

        .input-box-hidden { 
            position: absolute; 
            opacity: 0; 
            pointer-events: none; 
            height: 1px;
            width: 1px;
            padding: 0;
            margin: 0;
        }

        .countdown-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); 
            color: white;
            font-size: 8em;
            font-weight: 700;
            display: none; 
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            z-index: 10;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 20; 
            left: 0; top: 0;
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            margin: 5% auto; 
            padding: 40px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            width: 90%; 
            max-width: 500px;
            text-align: center;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .modal-content h2 {
            color: var(--accent-color);
            margin-bottom: 20px;
            font-size: 2.2em;
        }

        .modal-results p {
            font-size: 1.2em;
            margin: 10px 0;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
            text-align: left;
            padding-left: 20px;
        }

        .modal-results .final-value {
            font-weight: 700;
            color: var(--success-color);
            float: right;
        }

        .modal-results .error-value {
            color: var(--error-color);
        }

        /* Медиа-запросы */
        @media (max-width: 600px) {
            .text-window {
                width: 100%; 
                padding: 0 10px;
                font-size: 1.5em;
            }
            .theme-toggle-btn {
                position: static;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 class="logo">mytype.<span class="pro">pro</span></h1>
        <a href="http://92.255.76.131:8000/docs"><h1 class="logo">mytype.<span class="pro">docs</span></h1></a>
        <p>Нажмите чтобы перейти</p>
        <p class="slogan">Фокус. Скорость. Мастерство.</p>
        
        <button id="theme-toggle" class="theme-toggle-btn">
            Сменить тему (☀️)
        </button>
    </header>

    <main>
        <div class="test-container">
            <div class="time-selector">
                <button class="time-btn" data-time="60">1 мин</button>
                <button class="time-btn active" data-time="180">3 мин</button>
                <button class="time-btn" data-time="300">5 мин</button>
            </div>
            
            <div class="info-panel">
                <div class="info-item">
                    <span class="label">Таймер:</span>
                    <span id="timer-display" class="value">03:00</span>
                </div>
                <div class="info-item">
                    <span class="label">Ошибки:</span>
                    <span id="error-count" class="value error-value">0</span>
                </div>
                <div class="info-item">
                    <span class="label">Знаки/мин:</span>
                    <span id="cpm-display" class="value">0</span>
                </div>
            </div>

            <div class="typing-area card">
                
                <input type="text" id="input-field" class="input-box-hidden" autofocus autocomplete="off" autocapitalize="off" spellcheck="false">

                <div class="text-window">
                    <div id="text-to-type" class="text-source">
                        </div>
                </div>
                
                <button id="start-btn" class="start-button">Начать</button>
                <div id="countdown-overlay" class="countdown-overlay">3</div>
            </div>
        </div>
    </main>

    <div id="results-modal" class="modal">
        <div class="modal-content">
            <h2>Результаты разминки! 🏆</h2>
            <div class="modal-results">
                <p>Время печати: <span id="res-time" class="final-value">0</span> сек.</p>
                <p>Скорость: <span id="res-cpm" class="final-value">0 зн/мин</span></p>
                <p>Всего напечатано: <span id="res-chars" class="final-value">0</span> симв.</p>
                <p>Ошибки: <span id="res-errors" class="final-value error-value">0</span></p>
                <p>Точность: <span id="res-accuracy" class="final-value">0%</span></p>
            </div>
            <button id="modal-new-test-btn" class="start-button">Новый тест</button>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 mytype.pro</p>
        <p>&copy; <a href="http://92.255.76.131:8000/dev">sergaytrain</a></p>
    </footer>

    <script>
        // ====================================================================
        // --- JAVASCRIPT ---
        // ====================================================================

        const textSnippets = [
            "Программирование — это искусство превращать кофе в код, а сложные задачи — в элегантные решения.",
            "Чем больше человек знает, тем больше он сомневается. Чем меньше знает, тем категоричнее судит.",
            "Всё гениальное просто. Всё простое гениально. Найди свой путь к идеальной печати.",
            "Скорость печати — это не только тренировка пальцев, но и внимательность, и концентрация на тексте.",
            "Ешьте, молитесь, любите, но не забывайте про регулярную разминку для своих рук и мозга.",
            "Жизнь как коробка шоколадных конфет: никогда не знаешь, что тебе попадётся в следующий раз.",
            "Быстро, четко и без ошибок — вот три кита, на которых строится высокая производительность.",
            "Не откладывай на завтра то, что можно напечатать сегодня. Время — твой главный ресурс.",
            "Даже самый длинный путь начинается с первого шага, а самая высокая скорость — с первого символа.",
            "Когда ты думаешь, ты печатаешь. Когда ты печатаешь, ты думаешь. Закольцованный процесс.",
            "Музыка может изменить мир, потому что она может изменить людей и их настроение.",
            "Лучшее время для посадки дерева было двадцать лет назад. Следующее лучшее время — сегодня.",
            "Идеи приходят, когда мы меньше всего этого ожидаем. Главное — успеть их записать.",
            "Завтрак — самый важный приём пищи, дающий энергию для покорения новых вершин.",
            "Путешествия открывают глаза на мир и на самого себя. Не сиди на месте.",
            "Книга — лучший друг. Она может перенести тебя в любую эпоху и на любую планету.",
            "Улыбка ничего не стоит, но много даёт. Она обогащает тех, кто её получает, и не обедняет тех, кто её дарит.",
            "Спорт — это здоровье, дисциплина и отличный способ снять стресс после тяжелого дня.",
            "Великие дела совершаются не силой, а упорством и настойчивостью в достижении целей.",
            "Вода — это основа жизни. Пейте достаточно, чтобы ваш мозг работал на полную мощность.",
            "Терпение — это ключ, который открывает все двери, даже самые тяжелые и запертые.",
            "Красота находится в глазах смотрящего. Цените моменты и окружающий вас мир.",
            "Дружба — это дар. Берегите людей, которые вас поддерживают и верят в вас.",
            "Творчество — это способ души говорить на языке, который не нуждается в переводе.",
            "Опыт — это то, что ты получаешь, когда не получил то, что хотел, но чему-то научился.",
            "Любопытство — двигатель прогресса. Задавайте вопросы и ищите ответы.",
            "Учитесь на своих ошибках, но не зацикливайтесь на них. Двигайтесь вперёд.",
            "Солнечный свет — лучшее лекарство от плохого настроения и депрессии.",
            "Цифровая эпоха требует новых навыков. Скорость печати — один из них.",
            "Чем сложнее борьба, тем слаще победа. Никогда не сдавайтесь на полпути.",
            "Время летит, но хорошие воспоминания остаются навсегда в памяти.",
            "Иногда лучший способ решить проблему — это перестать её решать и дать себе отдохнуть.",
            "Искусство маленьких шагов приводит к большим результатам и достижениям.",
            "Счастье не зависит от того, что у нас есть, а от того, как мы к этому относимся.",
            "Изменения — это единственная константа в жизни. Будьте гибкими и адаптируйтесь.",
            "Семья — это самое важное. Найдите время для своих близких и любимых.",
            "Правда всегда побеждает ложь, хотя иногда это занимает много времени.",
            "Мечты не работают, пока вы не работаете над ними. Действуйте прямо сейчас.",
            "Простота в дизайне — это признак настоящего мастерства и элегантности.",
            "Забота о планете — это забота о нашем будущем и о наших детях.",
            "Движение — это жизнь. Не забывайте о физической активности каждый день.",
            "Каждый день — это новая возможность начать всё сначала и исправить ошибки.",
            "Невозможное сегодня станет возможным завтра при должном усердии.",
            "Смелость — это не отсутствие страха, а способность действовать, несмотря на него.",
            "Природа — великий учитель и целитель. Проводите больше времени на свежем воздухе.",
            "Цените тишину. В ней часто можно услышать самые важные ответы.",
            "Успех — это сумма маленьких усилий, повторяющихся изо дня в день.",
            "Технологии меняют мир. Освоение новых инструментов открывает двери.",
            "Секрет мотивации прост: начните делать, и вдохновение придет само.",
            "Здоровый сон — залог продуктивности и хорошего настроения с утра.",
            "Уважение к другим — это уважение к самому себе, отражающее вашу культуру.",
            "Дарите добро. Оно всегда возвращается в приумноженном виде, как эхо.",
            "Честность — самая дорогая вещь. Не ждите её от дешёвых людей.",
            "Путь к совершенству никогда не заканчивается, это бесконечный процесс.",
            "Начинайте свой день с благодарности за то, что у вас уже есть, и за возможности.",
            "Лучшая месть — это огромный успех и процветание в вашем деле.",
            "Не позволяйте вчерашнему дню занимать слишком много вашего сегодня.",
            "Изучайте историю. Она помогает понять настоящее и предвидеть будущее.",
            "Дисциплина — это мост между целями и их достижением, прочный и надежный.",
            "Интуиция — это голос души. Научитесь слушать себя и свои ощущения.",
            "Перемены начинаются с вас. Будьте тем изменением, которое вы хотите видеть.",
            "Один в поле не воин. Командная работа творит чудеса и решает проблемы.",
            "Настоящая свобода — это умение управлять своими мыслями и эмоциями.",
            "Финансовая грамотность — ключ к независимости и спокойной жизни.",
            "Найдите хобби, которое приносит радость и позволяет отдохнуть душой.",
            "Критическое мышление помогает не поддаваться манипуляциям и ложной информации.",
            "Слушайте больше, чем говорите. Так вы узнаете гораздо больше о мире.",
            "Уверенность в себе — это половина успеха в любом начинании, будьте смелы.",
            "Качество важнее количества, всегда стремитесь к совершенству.",
            "Планирование — это приведение будущего в настоящее, чтобы вы могли что-то с ним сделать.",
            "Любовь к профессии превращает работу в удовольствие и любимое дело.",
            "Не бойтесь пробовать новое. Жизнь слишком коротка для скучных занятий.",
            "Всегда оставайтесь студентом. Учитесь у каждого, кто встречается на пути.",
            "Прощение освобождает. Отпустите старые обиды и двигайтесь дальше.",
            "Гибкость мышления — это способность находить нестандартные решения.",
            "Порядок в доме — порядок в голове. Начните с рабочего стола.",
            "Техника печати — навык, который пригодится вам в любой сфере жизни.",
            "Скромность украшает, но уверенность в своих силах вдохновляет других.",
            "Вдохновение можно найти везде, главное — быть открытым и внимательным.",
            "Зима приходит с холодом, но приносит с собой уют и праздничное настроение.",
            "Осень — время для размышлений и подведения итогов уходящего года.",
            "Весна — символ обновления, новых надежд и ярких цветов вокруг нас.",
            "Лето дарит энергию солнца и возможность отдохнуть от повседневной суеты.",
            "Чем больше вы практикуетесь, тем меньше вы думаете о клавишах и их расположении.",
            "Дзен в печати — это когда пальцы знают, что делать, быстрее, чем мозг.",
            "Ваш мозг — это самый мощный компьютер. Разминайте его регулярно.",
            "Тайпинг — это диалог между вами и клавиатурой. Сделайте его гармоничным.",
            "Не спеши, но и не тормози. Найди свой идеальный ритм и темп.",
            "Оптимальный баланс между скоростью и точностью — вот ваша цель.",
            "Каждый удар по клавише — это шаг к мастерству, не пропускайте тренировки.",
            "Печатайте не глазами, а пальцами. Доверяйте мышечной памяти.",
            "Разминка нужна не только спортсменам, но и тем, кто много работает за компьютером.",
            "Фокус и внимание — ваши лучшие помощники в достижении высокой скорости.",
            "Начни с малого, но делай это постоянно, и результат тебя удивит.",
            "Усталость — враг скорости. Делайте перерывы и давайте глазам отдохнуть.",
            "Клавиатура ждёт вас. Пришло время показать, на что вы способны, печатайте!",
            "Мы не рождаемся с навыками, мы их приобретаем. Продолжайте практиковаться.",
            "Идеальная техника печати — это когда вы забываете о клавиатуре.",
            "Каждая ошибка — это просто повод нажать Backspace и стать лучше.",
            "Ваш рекорд ждёт, когда вы его побьёте. Приступайте к разминке!",
            "Секрет успеха — в ежедневной, пусть и небольшой, практике печати.",
            "Научитесь любить звук клавиш под вашими быстрыми пальцами.",
            "Не соревнуйтесь с другими, соревнуйтесь с самим собой вчерашним."
        ];

        // --- Настройки и переменные ---
        const TIME_OPTIONS = { '60': 60, '180': 180, '300': 300 };
        let gameTime = TIME_OPTIONS['180'];
        let timeLeft = gameTime;
        let textSpans = []; 

        let timerId = null;
        let countdownId = null;
        let isRunning = false;
        let isStarting = false;

        let errors = 0;
        let charactersTyped = 0;
        let correctCharacters = 0;

        // --- Элементы DOM ---
        const timeBtns = document.querySelectorAll('.time-btn');
        const timerDisplay = document.getElementById('timer-display');
        const errorCountDisplay = document.getElementById('error-count');
        const cpmDisplay = document.getElementById('cpm-display');
        const textToType = document.getElementById('text-to-type');
        const inputField = document.getElementById('input-field'); 
        const startBtn = document.getElementById('start-btn');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const resultsModal = document.getElementById('results-modal');
        const modalNewTestBtn = document.getElementById('modal-new-test-btn');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const textWindow = document.querySelector('.text-window'); 
        const favicon = document.getElementById('favicon'); 


        // --- Функции для управления иконкой сайта ---

        /**
         * Обновляет иконку сайта в зависимости от текущей темы
         */
        function updateFavicon() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const iconPath = currentTheme === 'dark' ? 'logowhite.ico' : 'logoblack.ico';
            favicon.href = iconPath;
        }

        /**
         * Проверяет предпочтительную тему браузера и устанавливает соответствующую иконку
         */
        function checkBrowserTheme() {
            // Проверяем, поддерживает ли браузер Media Query для темы
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // Если браузер в темной теме, устанавливаем темную тему сайта и белую иконку
                document.documentElement.setAttribute('data-theme', 'dark');
                updateFavicon();
            } else {
                // Если браузер в светлой теме, устанавливаем светлую тему сайта и черную иконку
                document.documentElement.setAttribute('data-theme', 'light');
                updateFavicon();
            }
        }

        // --- Функции Управления Текстом и Курсором ---

        /**
         * Обновляет отображение таймера в формате ММ:СС.
         */
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.innerText = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        /**
         * Перемещает текст так, чтобы курсор оставался в центре видимой области.
         * Использует offsetWidth для точного расчета смещения.
         */
        function updateTextScroll() {
            if (!textSpans.length) return;

            const nextCharIndex = charactersTyped;
            const windowWidth = textWindow.offsetWidth;
            const halfWindowWidth = windowWidth / 2;

            let targetOffset = 0;
            
            // Рассчитываем целевое смещение от НАЧАЛА текста до позиции курсора.
            const limit = (nextCharIndex < textSpans.length) ? nextCharIndex : textSpans.length;
            
            // Суммируем ширину всех напечатанных символов
            for (let i = 0; i < limit; i++) {
                targetOffset += textSpans[i].offsetWidth; 
            }

            // Итоговый сдвиг: (Сдвиг для центрирования) - (Позиция курсора)
            // Это гарантирует, что targetOffset (позиция курсора) будет выровнен по halfWindowWidth.
            const finalTransform = halfWindowWidth - targetOffset;

            textToType.style.transform = `translateX(${finalTransform}px)`;
        }

        /**
         * Устанавливает класс 'current' на следующий символ
         */
        function updateCurrentCharClass() {
            textSpans.forEach(span => span.classList.remove('current')); 
            
            if (textSpans[charactersTyped]) {
                textSpans[charactersTyped].classList.add('current');
            }
        }

        /**
         * Загружает следующий случайный текст и добавляет его в общую строку.
         */
        function loadNextText() {
            const randomIndex = Math.floor(Math.random() * textSnippets.length);
            const newText = textSnippets[randomIndex];
            
            // Пробел между текстами
            if (isRunning && textSpans.length > 0) {
                const spaceSpan = document.createElement('span');
                spaceSpan.innerText = ' ';
                textToType.appendChild(spaceSpan);
                textSpans.push(spaceSpan);
            }
            
            // Разбиваем новый текст на span-ы
            newText.split('').forEach(char => {
                const charSpan = document.createElement('span');
                charSpan.innerText = char;
                textToType.appendChild(charSpan);
                textSpans.push(charSpan);
            });
            
            if (isRunning) {
                updateCurrentCharClass();
                requestAnimationFrame(updateTextScroll); 
            }
        }

        /**
         * Расчет CPM (знаков в минуту).
         */
        function calculateCPM(elapsedSeconds) {
            if (elapsedSeconds <= 0) return 0;
            return (correctCharacters / elapsedSeconds) * 60;
        }

        /**
         * Инициализация/Сброс игры
         */
        function resetGame() {
            clearInterval(timerId);
            clearInterval(countdownId);
            
            isRunning = false;
            isStarting = false;
            errors = 0;
            charactersTyped = 0;
            correctCharacters = 0;
            textSpans = []; 
            timeLeft = gameTime; 

            // Обновление интерфейса
            inputField.value = '';
            inputField.disabled = false;
            startBtn.style.display = 'block';
            countdownOverlay.style.display = 'none';
            errorCountDisplay.innerText = '0';
            cpmDisplay.innerText = '0';
            updateTimerDisplay();
            resultsModal.style.display = 'none';

            // Загрузка стартового текста-плейсхолдера
            textToType.innerHTML = '';
            textToType.style.transform = `translateX(0)`; 
            const placeholder = document.createElement('span');
            placeholder.className = 'placeholder-text';
            placeholder.innerText = 'Нажмите "Начать" или просто начните печатать, чтобы запустить тест.';
            textToType.appendChild(placeholder);
            
            setTimeout(() => {
                inputField.focus();
            }, 10);
        }

        /**
         * Запускает 3-секундный обратный отсчет перед стартом печати.
         */
        function startCountdown() {
            if (isRunning) return; 

            resetGame(); 
            
            isStarting = true;
            startBtn.style.display = 'none';
            inputField.focus(); 

            let count = 3;
            countdownOverlay.style.display = 'flex';
            countdownOverlay.innerText = count;

            countdownId = setInterval(() => {
                count--;
                countdownOverlay.innerText = count;

                if (count <= 0) {
                    clearInterval(countdownId);
                    startTest();
                }
            }, 1000);
        }

        /**
         * Начинает сам тест печати.
         */
        function startTest() {
            isRunning = true;
            isStarting = false;
            countdownOverlay.style.display = 'none';

            textToType.innerHTML = ''; 
            textSpans = []; 
            loadNextText(); 
            
            // Запускаем основной таймер игры
            timerId = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    endGame();
                }
            }, 1000);
        }

        /**
         * Завершает игру и выводит финальные результаты.
         */
        function endGame() {
            isRunning = false;
            inputField.disabled = true;

            textSpans.forEach(span => span.classList.remove('current')); 

            const elapsedSeconds = gameTime - timeLeft;
            const finalCPM = calculateCPM(elapsedSeconds);
            const accuracy = (charactersTyped > 0) ? ((correctCharacters / charactersTyped) * 100) : 0;
            
            document.getElementById('res-time').innerText = `${elapsedSeconds}`;
            document.getElementById('res-cpm').innerText = `${finalCPM.toFixed(0)} зн/мин`;
            document.getElementById('res-chars').innerText = charactersTyped;
            document.getElementById('res-errors').innerText = errors;
            document.getElementById('res-accuracy').innerText = `${accuracy.toFixed(1)}%`;
            
            resultsModal.style.display = 'block';
        }

        // --- Обработчики Событий ---

        /**
         * Обработка ввода символов
         */
        inputField.addEventListener('keydown', (e) => {
            // 1. Предотвращаем Backspace
            if (e.key === 'Backspace') {
                e.preventDefault();
                return; 
            }
            
            // 2. Автозапуск по первому символу
            if (!isRunning && !isStarting && e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                e.preventDefault();
                startTest(); 
                return;
            }
            
            if (!isRunning) return;

            // 3. Обработка обычного символа
            if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey && e.key !== 'Shift') {
                e.preventDefault();
                
                if (charactersTyped >= textSpans.length) {
                    loadNextText(); 
                }
                
                const currentSpan = textSpans[charactersTyped];
                if (!currentSpan) return;

                currentSpan.classList.remove('current'); 
                
                if (e.key === currentSpan.innerText) {
                    currentSpan.classList.add('correct');
                    correctCharacters++;
                } else {
                    currentSpan.classList.add('incorrect');
                    errors++;
                    errorCountDisplay.innerText = errors;
                }
                
                charactersTyped++;
                
                // Обновляем CPM в реальном времени
                const elapsedSeconds = gameTime - timeLeft;
                const currentCPM = calculateCPM(elapsedSeconds);
                cpmDisplay.innerText = currentCPM.toFixed(0);
                
                updateCurrentCharClass();
                updateTextScroll();
                
                // Автоподгрузка нового текста
                if (charactersTyped >= textSpans.length) {
                    loadNextText();
                }
            }
        });

        // Обработчики кнопок времени
        timeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                timeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                gameTime = TIME_OPTIONS[btn.dataset.time];
                timeLeft = gameTime;
                updateTimerDisplay();
            });
        });

        // Кнопка "Начать"
        startBtn.addEventListener('click', startCountdown);

        // Кнопка "Новый тест"
        modalNewTestBtn.addEventListener('click', resetGame);

        // --- Управление темой ---
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            
            // Обновляем текст кнопки
            themeToggleBtn.innerText = newTheme === 'dark' ? 'Сменить тему (🌙)' : 'Сменить тему (☀️)';
            
            // Обновляем иконку сайта
            updateFavicon();
        });

        // --- Инициализация при загрузке ---
        document.addEventListener('DOMContentLoaded', () => {
            // Проверяем тему браузера и устанавливаем соответствующую иконку
            checkBrowserTheme();
            
            // Устанавливаем начальное состояние
            resetGame();
            
            // Слушаем изменения темы браузера в реальном времени
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    checkBrowserTheme();
                });
            }
        });
    </script>
</body>
</html>